---
title: 全息日志
tags:
---
# 全息日志

> 通过日志可以洞见请求的全部

## 概念

1. 生命周期 -- 即请求周期，接收到`request`请求开始，到`response`回包完成
1. 用户标识 -- 当前请求用户标识，可以没有，以下简称`UID`
1. 上下文 -- 与生命周期绑定的全局变量
1. 全息日志 -- 生命周期内产生的日志
1. 抓包 -- 生命周期内产生的IO日志
1. 染色用户 -- 对于添加到白名单中的`UID`，称为染色用户

## 常用API

> 更多API参考[logger.js](/doc/api/logger)

1. 获取日志对象
    ```js
    const logger = plug('logger');
    ```
1. 获取当前请求用户标识
    ```js
    const uid = logger.getKey();
    ```
1. 设置当前请求用户标识
    ```js
    logger.setKey(uid);
    ```
1. 获取当前请求已产生的全息日志
    ```js
    const text = logger.getText();
    ```

## 染色

1. 染色用户的日志可实时查看
1. 四种方式可对`UID`染色
    1. 在`config.alphaFile`本地文件中声明
        ```js
        //染色文件格式：一行一个UID，字符集[0-9a-zA-Z_\-]{0,64}
        123456
        1234567 //备注
        ```
    1. 在`config.alphaFileUrl`远程文件中声明
    1. 临时染色 -- 当天有效，0点自动清除
    1. 添加测试环境 -- 当天有效，0点自动清除


## 查看实时日志

1. 实时日志保留最新`64`条，滚动记录，`24h`过期
1. 访问`https://${appid}.tswjs.org/log/view/${UID}`即可
    1. `appid` -- 应用对应的`appid`
    1. `uid` -- 对应染色的`uid`

## 实现原理

1. 利用`上下文全局可见`的特性
1. 日志产生时，将处在低维的日志发送给上下文
1. 生命周期结束时，从上下文中获取其持有的日志，决策上报或是丢弃
1. 在管理端将上报的全息日志显示出来
1. 抓包可以看成是IO产生的非文本日志，提供下载

## 故障排除

- 对用户染色后，实时日志为空，排查清单
    1. 确认是染色用户，即`UID`在以下白名单内即可，（之一即可）
        - `config.alphaFile`
        - `config.alphaFileUrl`
        - 临时染色名单
        - 测试环境名单
    1. 确认代码运行过程中有声明过用户`UID`，且`UID`与染色相对应
        - 可调用`logger.setKey(uid)`声明当前请求的`UID`
    1. 确认运行时`debug`日志有输出`logType: alpha`关键字
    1. 排查`openapi.tswjs.org`域名是否连通，特别是`443`端口
    1. 确认`appid+appkey`无误，并重启使其生效
    1. 如果以上还不能解决，直接联系TSW协助排查

